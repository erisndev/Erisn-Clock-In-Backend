// `/models/weeklyreport.js`

```js
const mongoose = require("mongoose");

const WeeklyReportSchema = new mongoose.Schema(
  {
    userId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
    },

    weekStart: {
      type: Date,
      required: true,
    },

    weekEnd: {
      type: Date,
      required: true,
    },

    summary: { type: String, required: true },
    challenges: { type: String, default: "" },
    learnings: { type: String, default: "" },
    goals: { type: String, default: "" },

    status: {
      type: String,
      enum: ["Pending", "Submitted", "Reviewed", "Approved", "Rejected"],
      default: "Submitted",
    },
  },
  { timestamps: true }
);

// Prevent duplicate week submissions
WeeklyReportSchema.index(
  { userId: 1, weekStart: 1, weekEnd: 1 },
  { unique: true }
);

module.exports = mongoose.model("WeeklyReport", WeeklyReportSchema);
```

// `/controllers/reportController.js`

```js
const WeeklyReport = require("../models/weeklyreport");
const { exportCSV, exportPDF } = require("../exportUtils");

// CREATE REPORT (prevent duplicate week)
exports.submitReport = async (req, res) => {
  try {
    const exists = await WeeklyReport.findOne({
      userId: req.user.id,
      weekStart: req.body.weekStart,
      weekEnd: req.body.weekEnd
    });

    if (exists)
      return res.status(400).json({ message: "Report for this week already exists." });

    const report = await WeeklyReport.create({
      ...req.body,
      userId: req.user.id,
    });

    res.status(201).json(report);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// UPDATE REPORT
exports.updateReport = async (req, res) => {
  try {
    const report = await WeeklyReport.findOneAndUpdate(
      { _id: req.params.id, userId: req.user.id },
      req.body,
      { new: true }
    );

    if (!report) return res.status(404).json({ message: "Report not found" });

    res.json(report);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// VIEW SINGLE REPORT
exports.getReportById = async (req, res) => {
  try {
    const report = await WeeklyReport.findOne({
      _id: req.params.id,
      userId: req.user.id,
    });

    if (!report) return res.status(404).json({ message: "Not found" });

    res.json(report);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// FETCH ALL REPORTS FOR LOGGED IN USER
exports.getMyReports = async (req, res) => {
  try {
    const reports = await WeeklyReport.find({ userId: req.user.id }).sort({
      weekStart: -1,
    });

    res.json(reports);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// EXPORT MY REPORTS (CSV or PDF)
exports.exportMyReports = async (req, res) => {
  try {
    const reports = await WeeklyReport.find({ userId: req.user.id });

    if (req.query.type === "csv") {
      return exportCSV(res, reports);
    }
    if (req.query.type === "pdf") {
      return exportPDF(res, reports);
    }

    res.status(400).json({ message: "Invalid export type" });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};
```

// `/controllers/adminController.js`

(Admin-wide filtering by date & user)

```js
const WeeklyReport = require("../models/weeklyreport");
const { exportCSV, exportPDF } = require("../exportUtils");

// ADMIN: FILTER ALL REPORTS
exports.adminGetReports = async (req, res) => {
  try {
    const { userId, startDate, endDate, status } = req.query;

    let query = {};

    if (userId) query.userId = userId;
    if (startDate) query.weekStart = { $gte: new Date(startDate) };
    if (endDate) query.weekEnd = { ...query.weekEnd, $lte: new Date(endDate) };
    if (status) query.status = status;

    const reports = await WeeklyReport.find(query)
      .populate("userId", "name email")
      .sort({ weekStart: -1 });

    res.json(reports);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// ADMIN EXPORT CSV/PDF
exports.adminExportReports = async (req, res) => {
  try {
    const reports = await WeeklyReport.find().populate("userId", "name email");

    if (req.query.type === "csv") return exportCSV(res, reports);
    if (req.query.type === "pdf") return exportPDF(res, reports);

    res.status(400).json({ message: "Invalid export type" });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};
```

// `/routes/reportRoutes.js` (User routes)

```js
const express = require("express");
const router = express.Router();
const {
  submitReport,
  updateReport,
  getMyReports,
  getReportById,
  exportMyReports,
} = require("../controllers/reportController");

const auth = require("../middleware/auth"); // protect routes

router.post("/", auth, submitReport);
router.put("/:id", auth, updateReport);
router.get("/", auth, getMyReports);
router.get("/:id", auth, getReportById);
router.get("/export/data", auth, exportMyReports);

module.exports = router;
```

// `/routes/adminRoutes.js`

```js
const express = require("express");
const router = express.Router();
const {
  adminGetReports,
  adminExportReports
} = require("../controllers/adminController");

const admin = require("../middleware/admin"); // only admins allowed

router.get("/reports", admin, adminGetReports);
router.get("/reports/export", admin, adminExportReports);

module.exports = router;
```

// `/exportUtils.js` (CSV + PDF Export)

```js
const { jsPDF } = require("jspdf");
const { Parser } = require("json2csv");

// EXPORT CSV
exports.exportCSV = (res, data) => {
  const fields = [
    "userId",
    "weekStart",
    "weekEnd",
    "summary",
    "challenges",
    "learnings",
    "goals",
    "status",
    "createdAt"
  ];

  const parser = new Parser({ fields });
  const csv = parser.parse(data);

  res.header("Content-Type", "text/csv");
  res.attachment("reports.csv");
  return res.send(csv);
};

// EXPORT PDF
exports.exportPDF = (res, data) => {
  const doc = new jsPDF();

  doc.setFontSize(14);
  doc.text("Weekly Reports Export", 10, 10);

  let y = 20;
  data.forEach((r, i) => {
    doc.setFontSize(10);
    doc.text(
      `Report ${i + 1} | Week: ${r.weekStart.toISOString().substring(0,10)} - ${r.weekEnd.toISOString().substring(0,10)}`,
      10,
      y
    );
    y += 6;
    doc.text(`Summary: ${r.summary}`, 10, y);
    y += 6;
    doc.text(`Status: ${r.status}`, 10, y);
    y += 10;

    if (y > 270) {
      doc.addPage();
      y = 20;
    }
  });

  const pdf = doc.output();

  res.setHeader("Content-Type", "application/pdf");
  res.setHeader("Content-Disposition", "attachment; filename=reports.pdf");
  res.send(Buffer.from(pdf, "binary"));
};